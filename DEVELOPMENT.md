# 📔 开发者手册

> [!note]
>
> 本手册尚有很多待完善之处！

本文档旨在说明如何对项目进行开发，统一和规范开发过程，确保项目的开发质量。

祝开发愉快！

## ⚙ 项目结构与配置

本项目采用 VC/C++ 开发，并使用 Microsoft Foundation Class (MFC) 进行前端开发，使用的 IDE 是 Visual Studio。

> [!tip]
>
> 在 Visual Studio 中，可以在“视图”工具栏的下拉选项打开“类视图”，有时这会使得项目结构更加清晰。
>
> 也可以按 `Ctrl + Shift + C` 呼出类视图。

项目的筛选器结构像是这样：

```text
SWTools
|--- 头文件
|	|--- 后端
|	|	|--- mlib
|	|	|--- jsonxx
|	| 	| # 这里放其他后端头文件
|	|
|	|--- 前端
|		|--- 杂项
|		| # 这里放其他前端头文件
|
|--- 源文件
|	|--- 后端
|	|	|--- jsonxx
|	|	| # 这里放其他后端源文件
|	|
|	|--- 前端
|
|--- 资源文件
    （略） 
```

> [!note]
>
> 前端文件中，除了“杂项”下的文件，各头文件和源文件都以文件中声明 / 定义的类命名。
>
> 默认的 MFC 类以“C”废除，考虑到这样做有些冗余，本项目不遵从这一原则。

### 额外的项目配置

配置项目时，需要对项目属性做以下必要的设置：

- C/C++ > 语言 > C++ 语言标准：设置为：**ISO C++17 标准 (/stdc++17)**。
- C/C++ > 常规 > SDL 检查：设置为：**否 (/sdl-)**。

## 💻 开发周期

- 每次开发总是从新建一个开发分支开始，分支名字默认用 `dev`。

- 开发完成后，创建一个 Pull Resuest（然后进行审查、最后的修改等），然后合并到主分支 `master`。

发布前的准备：修改程序中的版本号，不要忘了资源视图中 **Version** / **VS_VERSION_INFO** 中的版本号；同时更新云端的最新版本号记录。

- 最后发布 Release。测试版（beta 版）记得在发布页面勾选“**Set as a pre-release**（设置为预发布）”。

版本号形如：`v1.2.3`，其中 `1` 是主要版本号，`2` 是次要版本号，`3` 是次次要版本号。`v1.2.13` 这样的也行。

如果没有对程序架构做大的改动，沿用主要版本号；添加 / 修改了功能，让次要版本号 +1；修复程序中的问题，让次次要版本号 +1。

## 🛠 后端

本小节中提到的所有后端文件都放在 `backend/` 文件夹下，且在解决方案视图中的“后端”筛选器下。

> [!note]
>
> 实际上前端和后端完全可以分开开发（在本地创建两个 `.sln` 解决方案）。但这取决于个人习惯。

| 头文件    | 源文件      | 说明                                                         |
| --------- | ----------- | ------------------------------------------------------------ |
| backend.h | backend.cpp | 此组件集合了所有的后端功能，前端 `SWTools.cpp` 包含了 `backend.h`。此外，此组件还提供了 `ExecuteCmd()`（可以阻塞地、静默地执行命令行）、`ToWstr()`、`ToStr()` 三个工具函数，它们在项目中比较常用。 |

下面的头文件都在 `backend.h` 中被包含：

| 头文件     | 源文件                             | 说明                                                         |
| ---------- | ---------------------------------- | ------------------------------------------------------------ |
| tasker.h   | tasker.cpp                         | 任务执行器，前端类 `SWTools` 拥有此组件的实例，同时这也是最主要的后端接口。前端通过与此接口互操作，实现**异步**的（解析、下载等）任务处理。此组件拥有一个“**任务线程**”。（**TODO：**把需要阻塞完成的任务交给此线程来做。） |
| app_name.h | 无                                 | 记录了 SteamApp ID 对应的 SteamApp 名称。                    |
| item.h     | item.cpp                           | 定义了存储创意工坊物品有关信息（如物品 ID、标题等）的结构体 `ItemInfo`，以及拥有这个结构体的类 `Item`。其成员 `Item::parseInfo()` 提供了从物品 ID 解析完整信息的功能（通过请求 https://steamworkshopdownloader.io/api/）。 |
| userpool.h | userpool.cpp, userpool_private.cpp | 用户池。定义了类 `UserPool`，其所有成员都是静态的，意味着不必实例化此组件就可以调用相关功能。 |

> [!note]
>
> `UserPool::appendPricateUserPool()` 的实现放在 `userpool_pricate.cpp`，用于追加受保护的用户池；而其他用户池在构造函数中被追加（在 `userpool.cpp` 中）。
>
> 上传到 Github 的 `userpool_private.cpp` 包含一个 `UserPool::appendPrivateUserPool()` 的**空实现**，仅保证可以编译。

> [!warning]
>
> 为了保护捐赠者的账户，包含受保护的用户池的 `UserPool::appendPrivateUserPool()` 实现**不能上传到 Github，请务必注意**。建议**仅在构建发布版时**用包含内容的 `userpool_private.cpp` 替换项目中的文件。

下面是外部库：

| 头文件              | 源文件              | 说明                                             |
| ------------------- | ------------------- | ------------------------------------------------ |
| mlib / function.hpp | 无（仅标头库）      | 提供一些实用函数，同时也是 mlib::Logger 的依赖项 |
| mlib / logger.hpp   | 无（仅标头库）      | 提供一个日志记录器。                             |
| mlib / process.hpp  | 无（仅标头库）      | 提供一个进程包装器，用于包装 SteamCmd 的进程。   |
| jsonxx / jsonxx.h   | jsonxx / jsonxx.cpp | 提供解析 JSON 文件的功能。                       |

## 🛠 前端

前端采用 MFC 构建，类型是“基于对话框的程序”。各种界面都以对话框为框架（基本上是一个窗口一个对话框）。

> [!note]
>
> MFC 中各种控件（如按钮、输入栏等）以及图像（图标）、对话框等都被视作“资源”，这意味着：
>
> - 其会有一个“资源ID”的宏定义，例如：`IDD_SWTOOLS_DIALOG`。此可以在资源视图和 `Resource.h` 中找到。
> - 在对话框的“设计视图”中，可以右键选择“添加类”、“添加对象”，以在代码中使用。
>
> 请务必为**宏定义**、创建的**类**名、创建的**变量**名起一个有意义的名字。特例是“Static Text”控件，可以忽略其名字。
>
> （上述的）变量命名原则：`m_[类型]_[描述]`，例如：`m_btn_openFoleder`。

前端的结构在“类视图”中看的很明白，这里就不写太多了。

> [!tip]
>
> 按 `Ctrl + Shift + C` 快速呼出类视图。

### 如何：添加初始化代码

比如设置列表的表头、设置文本框的文本（尤其是只读的）等等过程，属于“初始化代码”。

初始化代码在**应当添加在**：`CWToolsDlg::OnInitDialog()`，或者在 `SWToolsDlg.cpp` 中找到。

### 如何：创建新对话框

1. 首先转到“资源视图”，在 SWTools.rc > Dialog 右键，点击“添加资源”，在弹出的对话框左边选择“Dialog”，然后点“新建”。
2. 在“属性”窗口中修改 ID；并在设计视图中右键对话框，选择“添加类”。

> [!tip]
>
> 按 `Alt + Enter` 快速呼出属性窗口。

3. 不要忘了在属性窗口中修改“描述文字”。

### 关于界面中用到的图标

在用户界面中的部分按钮中添加了图标，这样可以让用户快速分辨按钮的功能。其实现步骤如下：

1. 在 [Flicon - Fluent UI Icon Search](https://www.flicon.io/) 上寻找合适的图标。为了保持风格统一，建议不要使用别的来源。
2. 下载 SVG 到本地，用 Photoshop 裁切成 256 px * 256px，并且为其着色，具体颜色见下文说明。
3. 保存为 `.png`，用工具转成 `.ico` 并拷贝到项目 `res/` 目录下。
4. 把图标文件添加到资源中，记得重命名。
5. 在 `CWToolsDlg::OnInitDialog()` 中添加设置按钮图标的初始化代码。

关于颜色：

- 程序的图标和大部分按钮图标使用颜色 **#13387B**（深蓝）。
- 涉及到“危险”操作（比如删除）的按钮图标使用颜色 **#7B1313**（深红）。
